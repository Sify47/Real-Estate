name: Daily Real Estate Scraping

on:
  schedule:
    - cron: '30 2 * * *'  # 2:30 AM UTC = 4:30 AM Egypt Time
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (2 pages only)'
        required: false
        default: 'no'
        type: choice
        options:
          - yes
          - no

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0  # Ø§Ø­Ø¶Ø± ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy requests beautifulsoup4 lxml
        
    - name: Backup current data
      run: |
        if [ -f "Final1.csv" ]; then
          cp Final1.csv Final1_backup_$(date +%Y%m%d_%H%M%S).csv
          echo "âœ… Backup created"
        fi
        
    - name: Run scraping script
      run: |
        if [ "${{ github.event.inputs.test_mode }}" = "yes" ]; then
          echo "ðŸ”§ Running in TEST mode (2 pages)"
          python -c "
          import scrape_data
          # ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¬Ù…Ø¹ ØµÙØ­ØªÙŠÙ† ÙÙ‚Ø·
          " || echo "Test completed"
        else
          echo "ðŸš€ Running in PRODUCTION mode"
          python scrape_data.py
        fi
        
    - name: Check for data loss
      run: |
        if [ -f "scraping_metadata.txt" ]; then
          echo "ðŸ“Š Scraping Results:"
          cat scraping_metadata.txt
          
          # ØªØ­Ù‚Ù‚ Ù…Ù† ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          if grep -q "Net change: -[0-9]*[1-9]" scraping_metadata.txt; then
            echo "âš ï¸ WARNING: Data loss detected!"
            echo "Restoring from backup..."
            ls -la Final1_backup_*.csv | tail -1 | awk '{print $9}' | xargs -I {} cp {} Final1.csv
          fi
        fi
        
    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        # ØªÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --name-only | grep -q "Final1.csv\|scraping_metadata.txt"; then
          echo "ðŸ“ Changes detected"
          
          git add Final1.csv scraping_metadata.txt
          
          # Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† metadata
          if [ -f "scraping_metadata.txt" ]; then
            NEW_PROPS=$(grep "New properties added:" scraping_metadata.txt | awk '{print $NF}')
            TOTAL_PROPS=$(grep "Total properties:" scraping_metadata.txt | awk '{print $NF}')
            COMMIT_MSG="Auto-scrape: Added $NEW_PROPS properties (Total: $TOTAL_PROPS) [$(date +'%Y-%m-%d %H:%M')]"
          else
            COMMIT_MSG="Auto-scrape: Update data [$(date +'%Y-%m-%d %H:%M')]"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # pull Ø£ÙˆÙ„Ø§Ù‹
          git pull origin main --rebase --strategy-option=theirs
          
          # push
          if git push origin main; then
            echo "âœ… Successfully pushed changes"
          else
            echo "âŒ Failed to push changes"
            exit 1
          fi
        else
          echo "âœ… No changes to commit"
        fi
        
    - name: Cleanup backups
      run: |
        # Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø­ØªÙØ¸ Ø¨Ù€ 5 Ø£Ø­Ø¯Ø«)
        ls -t Final1_backup_*.csv 2>/dev/null | tail -n +6 | xargs rm -f || true
        
    - name: Create summary
      run: |
        echo "### ðŸŽ‰ Scraping Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "scraping_metadata.txt" ]; then
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat scraping_metadata.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status:** No new data collected" >> $GITHUB_STEP_SUMMARY
        fi
